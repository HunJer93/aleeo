#!/bin/bash

# Integration Test Setup Script
# This script starts both Rails and React servers for integration testing
# and verifies they are accessible before running Cucumber tests

set -e  # Exit on any error

echo "ğŸš€ Starting integration test setup..."

# Configuration
RAILS_PORT=3000
REACT_PORT=3001
RAILS_ENV=test

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to check if a port is in use
check_port() {
    local port=$1
    if lsof -i :$port > /dev/null 2>&1; then
        return 0  # Port is in use
    else
        return 1  # Port is not in use
    fi
}

# Function to wait for server to be ready
wait_for_server() {
    local url=$1
    local timeout=$2
    local counter=0
    
    echo "Waiting for $url to be ready..."
    while [ $counter -lt $timeout ]; do
        if curl -s $url > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“ Server at $url is ready${NC}"
            return 0
        fi
        sleep 2
        counter=$((counter + 2))
        echo -n "."
    done
    
    echo -e "${RED}âœ— Server at $url failed to start within ${timeout}s${NC}"
    return 1
}

# Kill any existing processes on our ports
echo "ğŸ§¹ Cleaning up existing processes..."
if check_port $RAILS_PORT; then
    echo "Killing existing process on port $RAILS_PORT"
    lsof -ti :$RAILS_PORT | xargs -r kill -9 || true
fi

if check_port $REACT_PORT; then
    echo "Killing existing process on port $REACT_PORT"
    lsof -ti :$REACT_PORT | xargs -r kill -9 || true
fi

# Wait a moment for ports to be released
sleep 2

# Setup database
echo "ğŸ—„ï¸  Setting up test database..."
RAILS_ENV=$RAILS_ENV bundle exec rails db:create db:migrate
echo -e "${GREEN}âœ“ Database setup complete${NC}"

# Start Rails server
echo "âš¡ Starting Rails server on port $RAILS_PORT..."
RAILS_ENV=$RAILS_ENV bundle exec rails server -p $RAILS_PORT -d

# Start React server
echo "âš›ï¸  Starting React server on port $REACT_PORT..."
cd aleeo
export CI=false
export PORT=$REACT_PORT
npm start &
REACT_PID=$!
cd ..

# Wait for servers to be ready
echo "ğŸ•’ Waiting for servers to start..."
sleep 5

# Verify Rails server
if ! wait_for_server "http://localhost:$RAILS_PORT/api/v1/users" 30; then
    echo -e "${RED}âŒ Rails server failed to start properly${NC}"
    exit 1
fi

# Verify React server  
if ! wait_for_server "http://localhost:$REACT_PORT" 60; then
    echo -e "${RED}âŒ React server failed to start properly${NC}"
    
    # Kill React server if it's not responding
    if [ ! -z "$REACT_PID" ]; then
        kill $REACT_PID 2>/dev/null || true
    fi
    exit 1
fi

echo -e "${GREEN}ğŸ‰ All servers are ready for integration testing!${NC}"
echo ""
echo "ğŸ“ Server URLs:"
echo "   Rails API:    http://localhost:$RAILS_PORT"
echo "   React App:    http://localhost:$REACT_PORT"
echo ""
echo "ğŸ§ª You can now run integration tests with:"
echo "   bundle exec cucumber"
echo ""
echo "ğŸ›‘ To stop servers:"
echo "   ./bin/stop_test_servers"